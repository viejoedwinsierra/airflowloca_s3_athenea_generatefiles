~ $ 




~ $ mkdir practice
mkdir: cannot create directory ‘practice’: File exists
~ $ cd practice
practice $ 
practice $ cat > create_infra_EC2.sh <<'EOF'
> #!/bin/bash
> # ============================================================
> # Create EC2 (Amazon Linux 2) for Airflow - AWS Academy
> # Region: us-east-1
> # Uses: LabInstanceProfile
> # ============================================================
> 
> set -euo pipefail
> 
> REGION="us-east-1"
> INSTANCE_TYPE="t3.small"
> SECURITY_GROUP_NAME="bd-airflow-sg"
> INSTANCE_NAME="bd-airflow-ec2-$(date +%Y%m%d-%H%M%S)"
> KEY_NAME="${KEY_NAME:-}"                 # opcional: export KEY_NAME=mi-keypair
> MY_IP_CIDR="${MY_IP_CIDR:-0.0.0.0/0}"    # recomendado: export MY_IP_CIDR="TU_IP/32"
> 
> export AWS_REGION="$REGION"
> export AWS_DEFAULT_REGION="$REGION"
> 
> echo "==> Region: $REGION"
> 
> echo "==> Getting latest Amazon Linux 2 AMI via SSM"
> AMI_ID=$(aws ssm get-parameter \
>   --name /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2 \
>   --query "Parameter.Value" \
>   --output text)
> 
> if [[ -z "${AMI_ID}" || "${AMI_ID}" == "None" ]]; then
>   echo "ERROR: No AMI found for Amazon Linux 2 in ${REGION}"
>   exit 1
> fi
> echo "==> AMI_ID=${AMI_ID}"
> 
> echo "==> Getting default VPC"
> VPC_ID=$(aws ec2 describe-vpcs --filters "Name=isDefault,Values=true" --query "Vpcs[0].VpcId" --output text)
> if [[ -z "${VPC_ID}" || "${VPC_ID}" == "None" ]]; then
>   echo "ERROR: Default VPC not found in ${REGION}"
>   exit 1
> fi
> echo "==> VPC_ID=${VPC_ID}"
> 
> echo "==> Ensuring security group ${SECURITY_GROUP_NAME}"
> SG_ID=$(aws ec2 describe-security-groups \
>   --filters "Name=group-name,Values=${SECURITY_GROUP_NAME}" "Name=vpc-id,Values=${VPC_ID}" \
>   --query "SecurityGroups[0].GroupId" --output text 2>/dev/null || true)
> 
> if [[ -z "${SG_ID}" || "${SG_ID}" == "None" ]]; then
>   SG_ID=$(aws ec2 create-security-group \
>     --group-name "${SECURITY_GROUP_NAME}" \
>     --description "Security group for Airflow EC2 (SSH + 8080)" \
>     --vpc-id "${VPC_ID}" \
>     --query "GroupId" --output text)
>   echo "==> Created SG_ID=${SG_ID}"
> else
>   echo "==> Found SG_ID=${SG_ID}"
> fi
> 
> echo "==> Authorizing inbound rules (SSH 22, Airflow 8080) from ${MY_IP_CIDR}"
> aws ec2 authorize-security-group-ingress \
>   --group-id "${SG_ID}" \
>   --ip-permissions "IpProtocol=tcp,FromPort=22,ToPort=22,IpRanges=[{CidrIp=${MY_IP_CIDR},Description='SSH'}]" \
>   >/dev/null 2>&1 || true
> 
> aws ec2 authorize-security-group-ingress \
>   --group-id "${SG_ID}" \
>   --ip-permissions "IpProtocol=tcp,FromPort=8080,ToPort=8080,IpRanges=[{CidrIp=${MY_IP_CIDR},Description='Airflow Web'}]" \
>   >/dev/null 2>&1 || true
> 
> echo "==> Selecting a subnet (default VPC)"
> SUBNET_ID=$(aws ec2 describe-subnets \
>   --filters "Name=vpc-id,Values=${VPC_ID}" \
>   --query "Subnets | sort_by(@,&AvailabilityZone)[0].SubnetId" \
>   --output text)
> 
> if [[ -z "${SUBNET_ID}" || "${SUBNET_ID}" == "None" ]]; then
>   echo "ERROR: Subnet not found in VPC ${VPC_ID}"
>   exit 1
> fi
> echo "==> SUBNET_ID=${SUBNET_ID}"
> 
> echo "==> Launching EC2 instance..."
> TAG_SPEC="ResourceType=instance,Tags=[{Key=Name,Value=${INSTANCE_NAME}}]"
> 
> RUN_ARGS=(
>   --image-id "${AMI_ID}"
>   --count 1
>   --instance-type "${INSTANCE_TYPE}"
>   --security-group-ids "${SG_ID}"
>   --subnet-id "${SUBNET_ID}"
>   --iam-instance-profile Name=LabInstanceProfile
>   --tag-specifications "${TAG_SPEC}"
> )
> 
> if [[ -n "${KEY_NAME}" ]]; then
>   RUN_ARGS+=( --key-name "${KEY_NAME}" )
>   echo "==> Using KEY_NAME=${KEY_NAME}"
> else
>   echo "==> KEY_NAME not set (no SSH key pair will be attached)"
> fi
> 
> INSTANCE_ID=$(aws ec2 run-instances "${RUN_ARGS[@]}" --query "Instances[0].InstanceId" --output text)
> echo "==> INSTANCE_ID=${INSTANCE_ID}"
> 
> echo "==> Waiting until instance is running..."
> aws ec2 wait instance-running --instance-ids "${INSTANCE_ID}"
> 
> PUBLIC_IP=$(aws ec2 describe-instances --instance-ids "${INSTANCE_ID}" --query "Reservations[0].Instances[0].PublicIpAddress" --output text)
> PUBLIC_DNS=$(aws ec2 describe-instances --instance-ids "${INSTANCE_ID}" --query "Reservations[0].Instances[0].PublicDnsName" --output text)
> 
> echo "==> Ready!"
> echo "    Name: ${INSTANCE_NAME}"
> echo "    InstanceId: ${INSTANCE_ID}"
> echo "    Public IP: ${PUBLIC_IP}"
> echo "    Public DNS: ${PUBLIC_DNS}"
> echo "    Airflow URL (after install): http://${PUBLIC_IP}:8080"
> EOF
practice $ 
practice $ ls -ltr
total 4
-rwxr-xr-x. 1 cloudshell-user cloudshell-user 4094 Feb 20 16:08 create_infra_EC2.sh
practice $ 
practice $ chmod +x create_infra_EC2.sh
practice $ ls -l create_infra_EC2.sh
-rwxr-xr-x. 1 cloudshell-user cloudshell-user 4094 Feb 20 16:08 create_infra_EC2.sh
practice $ ./create_infra_EC2.sh
==> Region: us-east-1
==> Getting latest Amazon Linux 2 AMI via SSM
==> AMI_ID=ami-0199fa5fada510433
==> Getting default VPC
==> VPC_ID=vpc-0a9bfa6bde2059bb2
==> Ensuring security group bd-airflow-sg
==> Found SG_ID=sg-07c4293ecdde1d21b
==> Authorizing inbound rules (SSH 22, Airflow 8080) from 0.0.0.0/0
==> Selecting a subnet (default VPC)
==> SUBNET_ID=subnet-0fc23064593ec9708
==> Launching EC2 instance...
==> KEY_NAME not set (no SSH key pair will be attached)
==> INSTANCE_ID=i-0bc8cdf4e76dd12df
==> Waiting until instance is running...
==> Ready!
    Name: bd-airflow-ec2-20260220-160851
    InstanceId: i-0bc8cdf4e76dd12df
    Public IP: 44.201.225.188
    Public DNS: ec2-44-201-225-188.compute-1.amazonaws.com
    Airflow URL (after install): http://44.201.225.188:8080
practice $ echo "==> Conectar en la instancia!"
==> Conectar en la instancia!
practice $ aws ssm start-session --target i-0bc8cdf4e76dd12df

Starting session with SessionId: user4797248=edwin.sierra-p@mail.escuelaing.edu.co-8lig6gs7gogogqttt5cl8o469u
sh-4.2$ cd /home/ssm-user && pwd
/home/ssm-user
sh-4.2$ #instalaar doker 
sh-4.2$ sudo yum update -y
Loaded plugins: extras_suggestions, langpacks, priorities, update-motd
No packages marked for update
sh-4.2$ sudo amazon-linux-extras install -y docker
Installing docker
Loaded plugins: extras_suggestions, langpacks, priorities, update-motd
Cleaning repos: amzn2-core amzn2extra-docker
12 metadata files removed
4 sqlite files removed
0 metadata files removed
Loaded plugins: extras_suggestions, langpacks, priorities, update-motd
amzn2-core                                                                                                                                                                                          | 3.6 kB  00:00:00     
amzn2extra-docker                                                                                                                                                                                   | 2.9 kB  00:00:00     
(1/5): amzn2-core/2/x86_64/group_gz                                                                                                                                                                 | 2.7 kB  00:00:00     
(2/5): amzn2-core/2/x86_64/updateinfo                                                                                                                                                               | 1.2 MB  00:00:00     
(3/5): amzn2extra-docker/2/x86_64/updateinfo                                                                                                                                                        |  31 kB  00:00:00     
(4/5): amzn2extra-docker/2/x86_64/primary_db                                                                                                                                                        | 156 kB  00:00:00     
(5/5): amzn2-core/2/x86_64/primary_db                                                                                                                                                               |  83 MB  00:00:01     
Resolving Dependencies
--> Running transaction check
---> Package docker.x86_64 0:25.0.14-1.amzn2.0.2 will be installed
--> Processing Dependency: containerd >= 1.3.2 for package: docker-25.0.14-1.amzn2.0.2.x86_64
--> Processing Dependency: libcgroup >= 0.40.rc1-5.15 for package: docker-25.0.14-1.amzn2.0.2.x86_64
--> Processing Dependency: runc >= 1.0.0 for package: docker-25.0.14-1.amzn2.0.2.x86_64
--> Processing Dependency: pigz for package: docker-25.0.14-1.amzn2.0.2.x86_64
--> Running transaction check
---> Package containerd.x86_64 0:2.1.5-1.amzn2.0.5 will be installed
---> Package libcgroup.x86_64 0:0.41-21.amzn2 will be installed
---> Package pigz.x86_64 0:2.3.4-1.amzn2.0.1 will be installed
---> Package runc.x86_64 0:1.3.4-2.amzn2 will be installed
--> Finished Dependency Resolution

Dependencies Resolved

===========================================================================================================================================================================================================================
 Package                                           Arch                                          Version                                                    Repository                                                Size
===========================================================================================================================================================================================================================
Installing:
 docker                                            x86_64                                        25.0.14-1.amzn2.0.2                                        amzn2extra-docker                                         46 M
Installing for dependencies:
 containerd                                        x86_64                                        2.1.5-1.amzn2.0.5                                          amzn2extra-docker                                         20 M
 libcgroup                                         x86_64                                        0.41-21.amzn2                                              amzn2-core                                                66 k
 pigz                                              x86_64                                        2.3.4-1.amzn2.0.1                                          amzn2-core                                                81 k
 runc                                              x86_64                                        1.3.4-2.amzn2                                              amzn2extra-docker                                        3.9 M

Transaction Summary
===========================================================================================================================================================================================================================
Install  1 Package (+4 Dependent packages)

Total download size: 71 M
Installed size: 261 M
Downloading packages:
(1/5): pigz-2.3.4-1.amzn2.0.1.x86_64.rpm                                                                                                                                                            |  81 kB  00:00:00     
(2/5): libcgroup-0.41-21.amzn2.x86_64.rpm                                                                                                                                                           |  66 kB  00:00:00     
(3/5): containerd-2.1.5-1.amzn2.0.5.x86_64.rpm                                                                                                                                                      |  20 MB  00:00:00     
(4/5): runc-1.3.4-2.amzn2.x86_64.rpm                                                                                                                                                                | 3.9 MB  00:00:00     
(5/5): docker-25.0.14-1.amzn2.0.2.x86_64.rpm                                                                                                                                                        |  46 MB  00:00:00     
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Total                                                                                                                                                                                       85 MB/s |  71 MB  00:00:00     
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  Installing : runc-1.3.4-2.amzn2.x86_64                                                                                                                                                                               1/5 
  Installing : containerd-2.1.5-1.amzn2.0.5.x86_64                                                                                                                                                                     2/5 
  Installing : libcgroup-0.41-21.amzn2.x86_64                                                                                                                                                                          3/5 
  Installing : pigz-2.3.4-1.amzn2.0.1.x86_64                                                                                                                                                                           4/5 
  Installing : docker-25.0.14-1.amzn2.0.2.x86_64                                                                                                                                                                       5/5 
  Verifying  : pigz-2.3.4-1.amzn2.0.1.x86_64                                                                                                                                                                           1/5 
  Verifying  : runc-1.3.4-2.amzn2.x86_64                                                                                                                                                                               2/5 
  Verifying  : docker-25.0.14-1.amzn2.0.2.x86_64                                                                                                                                                                       3/5 
  Verifying  : containerd-2.1.5-1.amzn2.0.5.x86_64                                                                                                                                                                     4/5 
  Verifying  : libcgroup-0.41-21.amzn2.x86_64                                                                                                                                                                          5/5 

Installed:
  docker.x86_64 0:25.0.14-1.amzn2.0.2                                                                                                                                                                                      

Dependency Installed:
  containerd.x86_64 0:2.1.5-1.amzn2.0.5                      libcgroup.x86_64 0:0.41-21.amzn2                      pigz.x86_64 0:2.3.4-1.amzn2.0.1                      runc.x86_64 0:1.3.4-2.amzn2                     

Complete!
  2  httpd_modules            available    [ =1.0  =stable ]
  3  memcached1.5             available    \
        [ =1.5.1  =1.5.16  =1.5.17 ]
  9  R3.4                     available    [ =3.4.3  =stable ]
 18  libreoffice              available    \
        [ =5.0.6.2_15  =5.3.6.1  =stable ]
 19  gimp                     available    [ =2.8.22 ]
 20  docker=latest            enabled      \
        [ =17.12.1  =18.03.1  =18.06.1  =18.09.9  =stable ]
 21  mate-desktop1.x          available    \
        [ =1.19.0  =1.20.0  =stable ]
 22  GraphicsMagick1.3        available    \
        [ =1.3.29  =1.3.32  =1.3.34  =stable ]
 25  testing                  available    [ =1.0  =stable ]
 26  ecs                      available    [ =stable ]
 27  corretto8                available    \
        [ =1.8.0_192  =1.8.0_202  =1.8.0_212  =1.8.0_222  =1.8.0_232
          =1.8.0_242  =stable ]
 32  lustre2.10               available    \
        [ =2.10.5  =2.10.8  =stable ]
 34  lynis                    available    [ =stable ]
 36  BCC                      available    [ =0.x  =stable ]
 37  mono                     available    [ =5.x  =stable ]
 38  nginx1                   available    [ =stable ]
 40  mock                     available    [ =stable ]
 43  livepatch                available    [ =stable ]
 45  haproxy2                 available    [ =stable ]
 46  collectd                 available    [ =stable ]
 47  aws-nitro-enclaves-cli   available    [ =stable ]
 48  R4                       available    [ =stable ]
 49  kernel-5.4               available    [ =stable ]
 50  selinux-ng               available    [ =stable ]
 52  tomcat9                  available    [ =stable ]
 55  kernel-5.10              available    [ =stable ]
 56  redis6                   available    [ =stable ]
 60  mock2                    available    [ =stable ]
 62  kernel-5.15              available    [ =stable ]
 63  postgresql14             available    [ =stable ]
 64  firefox                  available    [ =stable ]
 65  lustre                   available    [ =stable ]
 67  awscli1                  available    [ =stable ]
 68  php8.2                   available    [ =stable ]
 69  dnsmasq                  available    [ =stable ]
 70  unbound1.17              available    [ =stable ]
 72  collectd-python3         available    [ =stable ]
sh-4.2$ sudo systemctl enable --now docker
Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.
sh-4.2$ docker --version || sudo docker --version
Docker version 25.0.14, build 0bab007
sh-4.2$ #installar comp¿se
sh-4.2$ 
sh-4.2$ sudo curl -L "https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-x86_64" -o /usr/local/bin/docker-compose
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
100 60.8M  100 60.8M    0     0   163M      0 --:--:-- --:--:-- --:--:--  163M
sh-4.2$ sudo chmod +x /usr/local/bin/docker-compose
sh-4.2$ docker-compose version
Docker Compose version v2.29.7
sh-4.2$ 
sh-4.2$ mkdir -p ~/bin ~/airflow-lite
sh-4.2$ chmod 700 ~/bin
sh-4.2$ 
sh-4.2$ #ir a directorio
sh-4.2$ cd /home/ssm-user/airflow-lite &&
> 
> ^C
sh-4.2$ cd /home/ssm-user/airflow-lite
sh-4.2$ pwd
/home/ssm-user/airflow-lite
sh-4.2$ pwd
/home/ssm-user/airflow-lite
sh-4.2$ cat > docker-compose.lite.yaml << EOF
> services:
>   postgres:
>     image: postgres:16
>     container_name: airflow-postgres
>     environment:
>       POSTGRES_USER: airflow
>       POSTGRES_PASSWORD: airflow
>       POSTGRES_DB: airflow
>     volumes:
>       - postgres-db-volume:/var/lib/postgresql/data
>     healthcheck:
>       test: ["CMD-SHELL", "pg_isready -U airflow -d airflow"]
>       interval: 10s
>       timeout: 5s
>       retries: 10
>     restart: unless-stopped
> 
>   airflow-init:
>     image: apache/airflow:2.10.3
>     container_name: airflow-init
>     depends_on:
>       postgres:
>         condition: service_healthy
>     environment:
>       AIRFLOW_UID: "50000"
>       AIRFLOW__CORE__EXECUTOR: SequentialExecutor
>       AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow
>       AIRFLOW__CORE__LOAD_EXAMPLES: "false"
>       AIRFLOW__WEBSERVER__SECRET_KEY: "REEMPLAZA_POR_TOKEN_LARGO"
>       _AIRFLOW_WWW_USER_USERNAME: airflow
>       _AIRFLOW_WWW_USER_PASSWORD: airflow
>     volumes:
>       - ./dags:/opt/airflow/dags
>       - ./logs:/opt/airflow/logs
>       - ./plugins:/opt/airflow/plugins
>     command: >
>       bash -c "
>       airflow db migrate &&
>       airflow users create
>         --role Admin
>         --username airflow
>         --password airflow
>         --firstname Admin
>         --lastname User
>         --email admin@example.com
>       || true
>       "
>     restart: "no"
> 
>   airflow-webserver:
>     image: apache/airflow:2.10.3
>     container_name: airflow-webserver
>     depends_on:
>       postgres:
>         condition: service_healthy
>     environment:
>       AIRFLOW_UID: "50000"
>       AIRFLOW__CORE__EXECUTOR: SequentialExecutor
>       AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow
>       AIRFLOW__CORE__LOAD_EXAMPLES: "false"
>       AIRFLOW__WEBSERVER__SECRET_KEY: "REEMPLAZA_POR_TOKEN_LARGO"
>     volumes:
>       - ./dags:/opt/airflow/dags
>       - ./logs:/opt/airflow/logs
>       - ./plugins:/opt/airflow/plugins
>     ports:
>       - "8080:8080"
>     command: webserver
>     healthcheck:
>       test: ["CMD-SHELL", "curl -fsS http://localhost:8080/health || exit 1"]
>       interval: 20s
>       timeout: 5s
>       retries: 10
>     restart: unless-stopped
> 
>   airflow-scheduler:
>     image: apache/airflow:2.10.3
>     container_name: airflow-scheduler
>     depends_on:
>       postgres:
>         condition: service_healthy
>     environment:
>       AIRFLOW_UID: "50000"
>       AIRFLOW__CORE__EXECUTOR: SequentialExecutor
>       AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow
>       AIRFLOW__CORE__LOAD_EXAMPLES: "false"
>       AIRFLOW__WEBSERVER__SECRET_KEY: "REEMPLAZA_POR_TOKEN_LARGO"
>     volumes:
>       - ./dags:/opt/airflow/dags
>       - ./logs:/opt/airflow/logs
>       - ./plugins:/opt/airflow/plugins
>     command: scheduler
>     restart: unless-stopped
> 
> volumes:
>   postgres-db-volume:
> EOF
sh-4.2$ pwd && ls -ltr
/home/ssm-user/airflow-lite
total 4
-rw-r--r-- 1 ssm-user ssm-user 2831 Feb 20 16:14 docker-compose.lite.yaml
sh-4.2$ #archivo para ejecitar
sh-4.2$ rm run_airflow_optionA.sh
ags plugins
sudo chmod -R u+rwX,g+rX,o+rX logs dags plugins

log "== Ejecutando airflow-init =="
set +e
${DC} -f "${COMPOSE_FILE}" up airflow-init
INIT_RC=$?
set -e

if [[ "$INIT_RC" -ne 0 ]]; then
  log "ERROR en airflow-init"
  ${DC} -f "${COMPOSE_FILE}" logs --tail=200 airflow-init || true
  exit "$INIT_RC"
fi

log "== Levantando servicios =="
${DC} -f "${COMPOSE_FILE}" up -d

log "== Estado de contenedores =="
${DC} -f "${COMPOSE_FILE}" ps

log "== Esperando health 200 =="
for i in $(seq 1 40); do
  CODE="$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${AIRFLOW_PORT}/health || true)"
  if [[ "$CODE" == "200" ]]; then
    log "✅ OK: Airflow responde en puerto ${AIRFLOW_PORT}"
    exit 0
  fi
  sleep 2
done

log "WARN: No respondió 200. Mostrando logs webserver:"
${DC} -f "${COMPOSE_FILE}" logs --tail=200 airflow-webserver || true
exit 1
EOF

chmod +x run_airflow_optionA.sh
bash run_airflow_optionA.sh && echo "OK: syntax"rm: cannot remove ‘run_airflow_optionA.sh’: No such file or directory
sh-4.2$ cat > run_airflow_optionA.sh <<'EOF'
> #!/usr/bin/env bash
> set -Eeuo pipefail
> 
> # ===== CONFIGURACIÓN (Opción A) =====
> PROJECT_DIR="${PROJECT_DIR:-$HOME/airflow-lite}"
> COMPOSE_FILE="${COMPOSE_FILE:-docker-compose.lite.yaml}"
> AIRFLOW_PORT="${AIRFLOW_PORT:-8080}"
> 
> log(){ printf "%s %s\n" "$(date -u +%FT%TZ)" "$*"; }
> die(){ log "ERROR: $*"; exit 1; }
> trap 'die "Fallo en línea ${BASH_LINENO[0]}: ${BASH_COMMAND}"' ERR
> 
> log "== Directorio del proyecto =="
> log "${PROJECT_DIR}"
> 
> cd "${PROJECT_DIR}" 2>/dev/null || die "No existe ${PROJECT_DIR}"
> [[ -f "${COMPOSE_FILE}" ]] || die "No existe ${PROJECT_DIR}/${COMPOSE_FILE}"
> 
> log "== Validando Docker =="
> command -v docker >/dev/null 2>&1 || die "Docker no instalado"
> 
> if ! systemctl is-active docker >/dev/null 2>&1; then
>   log "Iniciando docker..."
>   sudo systemctl enable --now docker
> fi
> 
> # ===== Resolver Compose (v2 plugin preferido) =====
> log "== Validando Compose =="
> NEED_SUDO=0
> if ! docker ps >/dev/null 2>&1; then
>   NEED_SUDO=1
>   log "Docker requiere sudo en esta sesión"
> fi
> 
> # Detectar compose v2 (docker compose) o v1 (docker-compose)
> if [[ "$NEED_SUDO" -eq 0 ]] && docker compose version >/dev/null 2>&1; then
>   DC="docker compose"
> elif [[ "$NEED_SUDO" -eq 1 ]] && sudo docker compose version >/dev/null 2>&1; then
>   DC="sudo docker compose"
> elif [[ "$NEED_SUDO" -eq 0 ]] && command -v docker-compose >/dev/null 2>&1; then
>   DC="docker-compose"
> elif [[ "$NEED_SUDO" -eq 1 ]] && command -v docker-compose >/dev/null 2>&1; then
>   # docker-compose existe pero docker requiere sudo → ejecutar con sudo
>   DC="sudo docker-compose"
> else
>   die "No se encontró 'docker compose' (v2) ni 'docker-compose' (v1)."
> fi
> 
> log "Usando: ${DC}"
> 
> log "== Validando compose config =="
> ${DC} -f "${COMPOSE_FILE}" config >/dev/null
> log "OK: compose válido"
> 
> # ===== Permisos Airflow (UID 50000) =====
> log "== Ajustando permisos de logs/dags/plugins =="
> ls -ld logs logs/scheduler 2>/dev/null || true
> 
> sudo mkdir -p logs dags plugins
> sudo chown -R 50000:0 logs dags plugins
> sudo chmod -R u+rwX,g+rX,o+rX logs dags plugins
> 
> log "== Ejecutando airflow-init =="
> set +e
> ${DC} -f "${COMPOSE_FILE}" up airflow-init
> INIT_RC=$?
> set -e
> 
> if [[ "$INIT_RC" -ne 0 ]]; then
>   log "ERROR en airflow-init"
>   ${DC} -f "${COMPOSE_FILE}" logs --tail=200 airflow-init || true
>   exit "$INIT_RC"
> fi
> 
> log "== Levantando servicios =="
> ${DC} -f "${COMPOSE_FILE}" up -d
> 
> log "== Estado de contenedores =="
> ${DC} -f "${COMPOSE_FILE}" ps
> 
> log "== Esperando health 200 =="
> for i in $(seq 1 40); do
>   CODE="$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${AIRFLOW_PORT}/health || true)"
>   if [[ "$CODE" == "200" ]]; then
>     log "✅ OK: Airflow responde en puerto ${AIRFLOW_PORT}"
>     exit 0
>   fi
>   sleep 2
> done
> 
> log "WARN: No respondió 200. Mostrando logs webserver:"
> ${DC} -f "${COMPOSE_FILE}" logs --tail=200 airflow-webserver || true
> exit 1
> EOF
sh-4.2$ 
sh-4.2$ chmod +x run_airflow_optionA.sh
sh-4.2$ bash run_airflow_optionA.sh && echo "OK: syntax"
2026-02-20T16:15:06Z == Directorio del proyecto ==
2026-02-20T16:15:06Z /home/ssm-user/airflow-lite
2026-02-20T16:15:06Z == Validando Docker ==
2026-02-20T16:15:06Z == Validando Compose ==
2026-02-20T16:15:06Z Docker requiere sudo en esta sesión
2026-02-20T16:15:06Z Usando: sudo docker-compose
2026-02-20T16:15:06Z == Validando compose config ==
sudo: docker-compose: command not found
2026-02-20T16:15:06Z ERROR: Fallo en línea 0: ${DC} -f "${COMPOSE_FILE}" config > /dev/null
sh-4.2$ # 1) Verifica dónde está docker-compose
sh-4.2$ command -v docker-compose
/usr/local/bin/docker-compose
sh-4.2$ ls -l /usr/local/bin/docker-compose
-rwxr-xr-x 1 root root 63785037 Feb 20 16:12 /usr/local/bin/docker-compose
sh-4.2$ 
sh-4.2$ # 2) Prueba con sudo usando PATH explícito
sh-4.2$ sudo env "PATH=$PATH" docker-compose version
Docker Compose version v2.29.7
sh-4.2$ #archivo para ejecitar
sh-4.2$ rm -f run_airflow_optionA.sh
ED_SUDO=1
  log "Docker requiere sudo en esta sesión"
fi

# Detectar compose v2 (docker compose) o v1 (docker-compose)
if [[ "$NEED_SUDO" -eq 0 ]] && docker compose version >/dev/null 2>&1; then
  DC="docker compose"
elif [[ "$NEED_SUDO" -eq 1 ]] && sudo -E env "PATH=$PATH" docker compose version >/dev/null 2>&1; then
  DC="sudo -E env \"PATH=$PATH\" docker compose"
elif [[ "$NEED_SUDO" -eq 0 ]] && command -v docker-compose >/dev/null 2>&1; then
  DC="docker-compose"
elif [[ "$NEED_SUDO" -eq 1 ]] && command -v docker-compose >/dev/null 2>&1; then
  # docker-compose existe pero docker requiere sudo → ejecutar con sudo (heredando PATH)
  DC="sudo -E env \"PATH=$PATH\" docker-compose"
else
  die "No se encontró 'docker compose' (v2) ni 'docker-compose' (v1)."
fi

log "Usando: ${DC}"

log "== Validando compose config =="
eval "${DC} -f \"${COMPOSE_FILE}\" config >/dev/null"
log "OK: compose válido"

# ===== Permisos Airflow (UID 50000) =====
log "== Ajustando permisos de logs/dags/plugins =="
ls -ld logs logs/scheduler 2>/dev/null || true

sudo mkdir -p logs dags plugins
sudo chown -R 50000:0 logs dags plugins
sudo chmod -R u+rwX,g+rX,o+rX logs dags plugins

log "== Ejecutando airflow-init =="
set +e
eval "${DC} -f \"${COMPOSE_FILE}\" up airflow-init"
INIT_RC=$?
set -e

if [[ "$INIT_RC" -ne 0 ]]; then
  log "ERROR en airflow-init"
  eval "${DC} -f \"${COMPOSE_FILE}\" logs --tail=200 airflow-init || true"
  exit "$INIT_RC"
fi

log "== Levantando servicios =="
eval "${DC} -f \"${COMPOSE_FILE}\" up -d"

log "== Estado de contenedores =="
eval "${DC} -f \"${COMPOSE_FILE}\" ps"

log "== Esperando health 200 =="
for i in $(seq 1 40); do
  CODE="$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${AIRFLOW_PORT}/health || true)"
  if [[ "$CODE" == "200" ]]; then
    log "✅ OK: Airflow responde en puerto ${AIRFLOW_PORT}"
    exit 0
  fi
  sleep 2
done

log "WARN: No respondió 200. Mostrando logs webserver:"
eval "${DC} -f \"${COMPOSE_FILE}\" logs --tail=200 airflow-webserver || true"
exit 1
EOF

chmod +x run_aish-4.2$ cat > run_airflow_optionA.sh <<'EOF'
> #!/usr/bin/env bash
> set -Eeuo pipefail
> 
> # ===== CONFIGURACIÓN (Opción A) =====
> PROJECT_DIR="${PROJECT_DIR:-$HOME/airflow-lite}"
> COMPOSE_FILE="${COMPOSE_FILE:-docker-compose.lite.yaml}"
> AIRFLOW_PORT="${AIRFLOW_PORT:-8080}"
> 
> log(){ printf "%s %s\n" "$(date -u +%FT%TZ)" "$*"; }
> die(){ log "ERROR: $*"; exit 1; }
> trap 'die "Fallo en línea ${BASH_LINENO[0]}: ${BASH_COMMAND}"' ERR
> 
> log "== Directorio del proyecto =="
> log "${PROJECT_DIR}"
> 
> cd "${PROJECT_DIR}" 2>/dev/null || die "No existe ${PROJECT_DIR}"
> [[ -f "${COMPOSE_FILE}" ]] || die "No existe ${PROJECT_DIR}/${COMPOSE_FILE}"
> 
> log "== Validando Docker =="
> command -v docker >/dev/null 2>&1 || die "Docker no instalado"
> 
> if ! systemctl is-active docker >/dev/null 2>&1; then
>   log "Iniciando docker..."
>   sudo systemctl enable --now docker
> fi
> 
> # ===== Resolver Compose (v2 plugin preferido) =====
> log "== Validando Compose =="
> NEED_SUDO=0
> if ! docker ps >/dev/null 2>&1; then
>   NEED_SUDO=1
>   log "Docker requiere sudo en esta sesión"
> fi
> 
> # Detectar compose v2 (docker compose) o v1 (docker-compose)
> if [[ "$NEED_SUDO" -eq 0 ]] && docker compose version >/dev/null 2>&1; then
>   DC="docker compose"
> elif [[ "$NEED_SUDO" -eq 1 ]] && sudo -E env "PATH=$PATH" docker compose version >/dev/null 2>&1; then
>   DC="sudo -E env \"PATH=$PATH\" docker compose"
> elif [[ "$NEED_SUDO" -eq 0 ]] && command -v docker-compose >/dev/null 2>&1; then
>   DC="docker-compose"
> elif [[ "$NEED_SUDO" -eq 1 ]] && command -v docker-compose >/dev/null 2>&1; then
>   # docker-compose existe pero docker requiere sudo → ejecutar con sudo (heredando PATH)
>   DC="sudo -E env \"PATH=$PATH\" docker-compose"
> else
>   die "No se encontró 'docker compose' (v2) ni 'docker-compose' (v1)."
> fi
> 
> log "Usando: ${DC}"
> 
> log "== Validando compose config =="
> eval "${DC} -f \"${COMPOSE_FILE}\" config >/dev/null"
> log "OK: compose válido"
> 
> # ===== Permisos Airflow (UID 50000) =====
> log "== Ajustando permisos de logs/dags/plugins =="
> ls -ld logs logs/scheduler 2>/dev/null || true
> 
> sudo mkdir -p logs dags plugins
> sudo chown -R 50000:0 logs dags plugins
> sudo chmod -R u+rwX,g+rX,o+rX logs dags plugins
> 
> log "== Ejecutando airflow-init =="
> set +e
> eval "${DC} -f \"${COMPOSE_FILE}\" up airflow-init"
> INIT_RC=$?
> set -e
> 
> if [[ "$INIT_RC" -ne 0 ]]; then
>   log "ERROR en airflow-init"
>   eval "${DC} -f \"${COMPOSE_FILE}\" logs --tail=200 airflow-init || true"
>   exit "$INIT_RC"
> fi
> 
> log "== Levantando servicios =="
> eval "${DC} -f \"${COMPOSE_FILE}\" up -d"
> 
> log "== Estado de contenedores =="
> eval "${DC} -f \"${COMPOSE_FILE}\" ps"
> 
> log "== Esperando health 200 =="
> for i in $(seq 1 40); do
>   CODE="$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${AIRFLOW_PORT}/health || true)"
>   if [[ "$CODE" == "200" ]]; then
>     log "✅ OK: Airflow responde en puerto ${AIRFLOW_PORT}"
>     exit 0
>   fi
>   sleep 2
> done
> 
> log "WARN: No respondió 200. Mostrando logs webserver:"
> eval "${DC} -f \"${COMPOSE_FILE}\" logs --tail=200 airflow-webserver || true"
> exit 1
> EOF
sh-4.2$ 
sh-4.2$ chmod +x run_airflow_optionA.sh
sh-4.2$ bash run_airflow_optionA.sh && echo "OK: syntax"
2026-02-20T16:19:23Z == Directorio del proyecto ==
2026-02-20T16:19:23Z /home/ssm-user/airflow-lite
2026-02-20T16:19:23Z == Validando Docker ==
2026-02-20T16:19:23Z == Validando Compose ==
2026-02-20T16:19:23Z Docker requiere sudo en esta sesión
2026-02-20T16:19:23Z Usando: sudo -E env "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin" docker-compose
2026-02-20T16:19:23Z == Validando compose config ==
2026-02-20T16:19:23Z OK: compose válido
2026-02-20T16:19:23Z == Ajustando permisos de logs/dags/plugins ==
2026-02-20T16:19:23Z == Ejecutando airflow-init ==
[+] Running 37/2
 ✔ airflow-init Pulled                                                                                                                                                                                               32.9s 
 ✔ postgres Pulled                                                                                                                                                                                                   15.2s 
[+] Running 4/4
 ✔ Network airflow-lite_default              Created                                                                                                                                                                  0.1s 
 ✔ Volume "airflow-lite_postgres-db-volume"  Created                                                                                                                                                                  0.0s 
 ✔ Container airflow-postgres                Created                                                                                                                                                                  0.7s 
 ✔ Container airflow-init                    Created                                                                                                                                                                  0.1s 
Attaching to airflow-init
airflow-init  | 
airflow-init  | /home/airflow/.local/lib/python3.12/site-packages/airflow/configuration.py:859 FutureWarning: section/key [core/sql_alchemy_conn] has been deprecated, you should use[database/sql_alchemy_conn] instead. Please update your `conf.get*` call to use the new name
airflow-init  | DB: postgresql+psycopg2://airflow:***@postgres/airflow
airflow-init  | Performing upgrade to the metadata database postgresql+psycopg2://airflow:***@postgres/airflow
airflow-init  | [2026-02-20T16:20:24.032+0000] {migration.py:207} INFO - Context impl PostgresqlImpl.
airflow-init  | [2026-02-20T16:20:24.034+0000] {migration.py:210} INFO - Will assume transactional DDL.
airflow-init  | [2026-02-20T16:20:24.035+0000] {migration.py:207} INFO - Context impl PostgresqlImpl.
airflow-init  | [2026-02-20T16:20:24.036+0000] {migration.py:210} INFO - Will assume transactional DDL.
airflow-init  | INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
airflow-init  | INFO  [alembic.runtime.migration] Will assume transactional DDL.
airflow-init  | INFO  [alembic.runtime.migration] Running stamp_revision  -> 5f2621c13b39
airflow-init  | Database migrating done!
airflow-init  | /home/airflow/.local/lib/python3.12/site-packages/airflow/configuration.py:859 FutureWarning: section/key [core/sql_alchemy_conn] has been deprecated, you should use[database/sql_alchemy_conn] instead. Please update your `conf.get*` call to use the new name
airflow-init  | 
airflow-init  | airflow users create command error: the following arguments are required: -e/--email, -f/--firstname, -l/--lastname, -r/--role, -u/--username, see help above.
airflow-init  | Usage: airflow users create [-h] -e EMAIL -f FIRSTNAME -l LASTNAME
airflow-init  |                             [-p PASSWORD] -r ROLE [--use-random-password] -u
airflow-init  |                             USERNAME [-v]
airflow-init  | 
airflow-init  | Create a user
airflow-init  | 
airflow-init  | Options:
airflow-init  |   -h, --help            show this help message and exit
airflow-init  |   -e, --email EMAIL     Email of the user
airflow-init  |   -f, --firstname FIRSTNAME
airflow-init  |                         First name of the user
airflow-init  |   -l, --lastname LASTNAME
airflow-init  |                         Last name of the user
airflow-init  |   -p, --password PASSWORD
airflow-init  |                         Password of the user, required to create a user without --use-random-password
airflow-init  |   -r, --role ROLE       Role of the user. Existing roles include Admin, User, Op, Viewer, and Public
airflow-init  |   --use-random-password
airflow-init  |                         Do not prompt for password. Use random string instead. Required to create a user without --password
airflow-init  |   -u, --username USERNAME
airflow-init  |                         Username of the user
airflow-init  |   -v, --verbose         Make logging output more verbose
airflow-init  | 
airflow-init  | examples:
airflow-init  | To create an user with "Admin" role and username equals to "admin", run:
airflow-init  | 
airflow-init  |     $ airflow users create \
airflow-init  |           --username admin \
airflow-init  |           --firstname FIRST_NAME \
airflow-init  |           --lastname LAST_NAME \
airflow-init  |           --role Admin \
airflow-init  |           --email admin@example.org
airflow-init  | /bin/bash: line 2: --role: command not found
airflow-init  | /bin/bash: line 3: --username: command not found
airflow-init  | /bin/bash: line 4: --password: command not found
airflow-init  | /bin/bash: line 5: --firstname: command not found
airflow-init  | /bin/bash: line 6: --lastname: command not found
airflow-init  | /bin/bash: line 7: --email: command not found
airflow-init  | /bin/bash: -c: line 8: syntax error near unexpected token `||'
airflow-init  | /bin/bash: -c: line 8: `|| true '
airflow-init exited with code 2
2026-02-20T16:20:29Z == Levantando servicios ==
[+] Running 4/4
 ✔ Container airflow-postgres   Healthy                                                                                                                                                                               0.6s 
 ✔ Container airflow-scheduler  Started                                                                                                                                                                               1.7s 
 ✔ Container airflow-init       Started                                                                                                                                                                               1.8s 
 ✔ Container airflow-webserver  Started                                                                                                                                                                               1.9s 
2026-02-20T16:20:31Z == Estado de contenedores ==
NAME                IMAGE                   COMMAND                  SERVICE             CREATED          STATUS                                     PORTS
airflow-init        apache/airflow:2.10.3   "/usr/bin/dumb-init …"   airflow-init        34 seconds ago   Up Less than a second                      8080/tcp
airflow-postgres    postgres:16             "docker-entrypoint.s…"   postgres            35 seconds ago   Up 33 seconds (healthy)                    5432/tcp
airflow-scheduler   apache/airflow:2.10.3   "/usr/bin/dumb-init …"   airflow-scheduler   2 seconds ago    Up Less than a second                      8080/tcp
airflow-webserver   apache/airflow:2.10.3   "/usr/bin/dumb-init …"   airflow-webserver   2 seconds ago    Up Less than a second (health: starting)   0.0.0.0:8080->8080/tcp, :::8080->8080/tcp
2026-02-20T16:20:31Z == Esperando health 200 ==
